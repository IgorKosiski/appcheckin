<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Check-in e Lista de Espera</title>
    <!-- Tailwind CSS (CDN) para estilização responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HTML5-QRCODE (para leitura de QR code) -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
    <style>
        /* Estilos customizados para o corpo da página e containers */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .container-app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
        }
        .card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 500px; /* Limite de largura para cartões de cadastro/login */
        }
        .manager-container {
            width: 100%;
            max-width: 900px;
        }
        .btn-primary {
            transition: all 0.2s;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>

<div id="app-container" class="container-app">

    <!-- Modal de Login (Tela Inicial) -->
    <div id="login-modal" class="w-full h-full flex items-center justify-center absolute inset-0 bg-gray-500 bg-opacity-75 z-50">
        <div class="card p-6 text-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Acesso Restrito</h2>
            <p class="text-gray-600 mb-6">Por favor, insira o PIN de acesso.</p>
            <input type="password" id="pin-input" class="w-full p-3 mb-4 border border-gray-300 rounded-lg text-lg text-center focus:ring-emerald-500 focus:border-emerald-500" placeholder="PIN de Acesso" maxlength="5">
            <button id="login-button" class="btn-primary w-full bg-emerald-600 text-white font-semibold py-3 rounded-lg hover:bg-emerald-700">Entrar</button>
            <p id="login-error" class="text-red-500 mt-3 hidden">PIN incorreto ou acesso não autorizado.</p>
            <p class="text-xs text-gray-400 mt-4">Gerente: 12345 | Scanner: 54321</p>
        </div>
    </div>
    
    <!-- Header de Navegação (visível após login) -->
    <div id="header-nav" class="w-full p-4 bg-white shadow-md mb-6 rounded-lg hidden max-w-5xl">
        <div class="flex flex-wrap justify-center gap-2">
            <button id="nav-manager" class="px-4 py-2 bg-emerald-500 text-white font-semibold rounded-full text-sm hover:bg-emerald-600 transition">Gerenciar Lista</button>
            <button id="nav-scanner" class="px-4 py-2 bg-sky-500 text-white font-semibold rounded-full text-sm hover:bg-sky-600 transition">Modo Scanner/NFC</button>
            <button id="nav-creator" class="px-4 py-2 bg-indigo-500 text-white font-semibold rounded-full text-sm hover:bg-indigo-600 transition">Gerar Credencial</button>
            <button id="nav-logout" class="px-4 py-2 bg-gray-300 text-gray-700 font-semibold rounded-full text-sm hover:bg-gray-400 transition ml-auto">Sair</button>
        </div>
    </div>

    <!-- Container Principal do App -->
    <main id="app-main-content" class="w-full flex-grow flex justify-center hidden">

        <!-- 1. Gerenciar Lista (Padrão/Gerente) -->
        <section id="manager-view" class="manager-container hidden">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Lista de Espera em Tempo Real</h1>
            <div id="waiting-list" class="space-y-4">
                <!-- A lista de espera será injetada aqui -->
                <p id="loading-list" class="text-center text-gray-500">Carregando lista...</p>
            </div>
            <div class="mt-8 p-3 bg-gray-100 rounded-lg text-xs text-gray-600">
                <p>ID do Usuário (Para Referência): <span id="user-id-display" class="font-mono text-emerald-700 break-all"></span></p>
            </div>
        </section>

        <!-- 2. Modo Scanner (Celular/Leitor) -->
        <section id="scanner-view" class="w-full max-w-md hidden">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Scanner de QR Code / NFC</h1>
            
            <!-- Área da Câmera / QR Code -->
            <div id="reader" class="w-full aspect-square bg-gray-200 rounded-xl overflow-hidden mb-6"></div>
            
            <p id="scanner-status" class="text-center text-gray-600">Aguardando leitura de QR Code ou ID via NFC...</p>

            <!-- Modal de Confirmação (Visível após a leitura) -->
            <div id="confirmation-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 z-40 hidden flex items-center justify-center p-4">
                <div class="card p-6 text-center max-w-sm">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Confirmar Cliente</h3>
                    <img id="client-photo" src="" alt="Foto do Cliente" class="w-24 h-24 rounded-full mx-auto object-cover mb-4 border-4 border-emerald-300">
                    <p class="text-xs text-gray-500 mb-1">Buscador (Cliente QR/NFC)</p>
                    <p id="modal-client-name" class="text-xl font-semibold text-gray-800 mb-3"></p>
                    
                    <div class="p-3 bg-indigo-50 rounded-lg mb-4 border border-indigo-200">
                        <p class="text-xs font-medium text-indigo-700">Pessoa Buscada & Turma</p>
                        <p id="modal-pickup-details" class="text-lg font-bold text-indigo-800"></p>
                    </div>

                    <p id="modal-status-message" class="text-sm font-medium mb-4 text-red-500"></p>
                    
                    <div class="flex gap-4">
                        <button id="confirm-identity-button" class="btn-primary flex-1 bg-emerald-600 text-white font-semibold py-3 rounded-lg hover:bg-emerald-700 disabled:opacity-50 transition">Confirmar Identidade</button>
                        <button id="cancel-scan-button" class="flex-1 bg-gray-300 text-gray-800 font-semibold py-3 rounded-lg hover:bg-gray-400 transition">Cancelar</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. Gerar Credencial (Gerente) -->
        <section id="creator-view" class="w-full max-w-md hidden">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Cadastro e Geração de Credencial</h1>
            <div class="card">
                <form id="credential-form" class="space-y-4">
                    <div>
                        <label for="client-id-input" class="block text-sm font-medium text-gray-700">ID Único do Cliente (Ex: CL001)</label>
                        <input type="text" id="client-id-input" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required placeholder="Gerado Automaticamente">
                    </div>
                    <div>
                        <label for="client-name-input" class="block text-sm font-medium text-gray-700">Nome do Buscador (Cliente)</label>
                        <input type="text" id="client-name-input" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required placeholder="Ex: Igor Kosiski">
                    </div>
                    <div>
                        <label for="pickup-name-input" class="block text-sm font-medium text-gray-700">Nome da Pessoa Buscada (Estudante)</label>
                        <input type="text" id="pickup-name-input" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required placeholder="Ex: Maria da Silva">
                    </div>
                    <div>
                        <label for="turma-input" class="block text-sm font-medium text-gray-700">Turma (do Buscado)</label>
                        <input type="text" id="turma-input" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required placeholder="Ex: 5º Ano B">
                    </div>
                    <div>
                        <label for="photo-url-input" class="block text-sm font-medium text-gray-700">URL da Foto do Buscador</label>
                        <input type="url" id="photo-url-input" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="URL da Foto (https://...)">
                        <p class="text-xs text-gray-500 mt-1">Use: https://placehold.co/128x128/059669/ffffff?text=FOTO+TESTE</p>
                    </div>
                    <button type="submit" class="btn-primary w-full bg-indigo-600 text-white font-semibold py-2 rounded-lg hover:bg-indigo-700 transition">Cadastrar Cliente e Gerar QR</button>
                    <p id="creator-status" class="text-sm mt-3 text-center"></p>
                </form>
                
                <div id="qrcode-container" class="mt-8 p-4 border border-gray-200 rounded-lg text-center hidden">
                    <h3 class="text-xl font-semibold mb-3">QR Code Gerado</h3>
                    <div id="qrcode-display" class="w-48 h-48 mx-auto"></div>
                    <p id="generated-client-id" class="mt-3 text-gray-600 font-mono text-sm break-all"></p>
                    <p class="text-xs text-red-500 mt-2">Salve esta imagem para o cliente.</p>
                </div>
            </div>
        </section>

    </main>
</div>

<!-- Scripts do Firebase e Lógica da Aplicação -->
<script type="module">
    // --- Configuração REAL do Firebase ---
    // ESTA CONFIGURAÇÃO PERMITE QUE O APP SE CONECTE AO SEU BANCO DE DADOS CHECKIN-ESCOLAR
    const REAL_FIREBASE_CONFIG = {
        apiKey: "AIzaSyAo8ujlZV0nh6CpPw7yvXgKjVDEOf0Q5Jc",
        authDomain: "checkin-escolar.firebaseapp.com",
        projectId: "checkin-escolar",
        storageBucket: "checkin-escolar.firebasestorage.app",
        messagingSenderId: "1028393700955",
        appId: "1:1028393700955:web:ebde11457658564451b97e",
        measurementId: "G-J3Y4P4E7CB"
    };

    // Usaremos o projectId como o APP ID
    const appId = REAL_FIREBASE_CONFIG.projectId; 
    const firebaseConfig = REAL_FIREBASE_CONFIG;
    // Não precisamos de um token inicial, usaremos autenticação anônima
    const initialAuthToken = null; 

    // O código de erro está aqui para garantir que a variável firebaseConfig esteja presente.
    if (!firebaseConfig) {
        document.getElementById('app-container').innerHTML = '<div class="text-red-600 p-8 text-center">Erro: Configuração do Firebase não encontrada. Por favor, acesse via URL do Servidor (GitHub Pages)</div>';
        console.error("Firebase config is missing.");
        throw new Error("Firebase configuration is required.");
    }

    // Importações do Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    let app, db, auth, userId;
    let html5QrCode;
    let userRole = null; // 'manager', 'scanner', or null

    // --- FUNÇÕES DE UTILIDADE ---

    async function getClientDetails(clientId) {
        const clientDetailsRef = doc(db, 'artifacts', appId, 'client_details', clientId);
        try {
            const docSnap = await getDoc(clientDetailsRef);
            if (docSnap.exists()) {
                return { 
                    clientName: docSnap.data().clientName,
                    pickupName: docSnap.data().pickupName,
                    turma: docSnap.data().turma,
                    photoUrl: docSnap.data().photoUrl || `https://placehold.co/128x128/059669/ffffff?text=${clientId.substring(0, 4)}`,
                };
            }
        } catch (error) {
            console.error("Erro ao buscar detalhes do cliente no Firestore:", error);
        }
        
        // Mock/Fallback para ID não encontrado
        return {
            clientName: `Cliente Desconhecido (${clientId})`,
            pickupName: "Pessoa Não Cadastrada",
            turma: "Turma ?",
            photoUrl: `https://placehold.co/128x128/94A3B8/ffffff?text=${clientId.substring(0, 4)}`,
        };
    }

    async function isClientWaiting(clientId) {
        const waitingListCol = collection(db, 'artifacts', appId, 'public', 'data', 'waiting_list');
        const q = query(waitingListCol, 
            where('clientId', '==', clientId),
            where('status', '==', 'waiting')
        );
        const snapshot = await getDocs(q);
        return snapshot.size > 0;
    }

    // --- FIREBASE E AUTENTICAÇÃO ---

    async function initFirebase() {
        if (app) return;
        
        setLogLevel('debug');
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        try {
            // Tenta autenticação anônima com as suas chaves
            await signInAnonymously(auth);
        } catch (error) {
            console.error("Erro na autenticação anônima:", error);
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                document.getElementById('user-id-display').textContent = userId;
            } else {
                userRole = null;
                document.getElementById('login-modal').classList.remove('hidden');
                document.getElementById('app-main-content').classList.add('hidden');
            }
        });
    }

    async function handleLogin() {
        const pinInput = document.getElementById('pin-input');
        const errorDisplay = document.getElementById('login-error');
        const pin = pinInput.value.trim();

        const configRef = doc(db, 'artifacts', appId, 'app_configs', 'access_pins');
        let pins = { managerPin: '12345', scannerPin: '54321' }; // Padrões

        try {
            const docSnap = await getDoc(configRef);
            if (docSnap.exists()) {
                pins = docSnap.data();
            } else {
                await setDoc(configRef, pins); // Salva os padrões iniciais
            }
        } catch (e) {
            console.warn("Não foi possível buscar/salvar PINs do Firestore, usando padrões locais.", e);
        }

        if (pin === pins.managerPin) {
            userRole = 'manager';
            errorDisplay.classList.add('hidden');
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('app-main-content').classList.remove('hidden');
            setupAppNavigation();
            showView('manager-view'); 
        } else if (pin === pins.scannerPin) {
            userRole = 'scanner';
            errorDisplay.classList.add('hidden');
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('app-main-content').classList.remove('hidden');
            setupAppNavigation();
            showView('scanner-view'); 
        } else {
            errorDisplay.classList.remove('hidden');
            pinInput.value = '';
            pinInput.focus();
        }
    }

    // --- NAVEGAÇÃO E VIEWS ---

    function setupAppNavigation() {
        document.getElementById('header-nav').classList.remove('hidden');

        const managerBtn = document.getElementById('nav-manager');
        const scannerBtn = document.getElementById('nav-scanner');
        const creatorBtn = document.getElementById('nav-creator');

        managerBtn.onclick = () => showView('manager-view');
        scannerBtn.onclick = () => showView('scanner-view');
        creatorBtn.onclick = () => showView('creator-view');
        document.getElementById('nav-logout').onclick = handleLogout;
        
        if (userRole === 'scanner') {
            managerBtn.classList.add('hidden');
            creatorBtn.classList.add('hidden');
        } else {
            managerBtn.classList.remove('hidden');
            creatorBtn.classList.remove('hidden');
        }
    }

    function showView(viewId) {
        ['manager-view', 'scanner-view', 'creator-view'].forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });

        if (viewId !== 'scanner-view' && html5QrCode && html5QrCode.isScanning) {
            stopScanner();
        }

        document.getElementById(viewId).classList.remove('hidden');
        
        if (viewId === 'manager-view') {
            loadWaitingList();
        } else if (viewId === 'scanner-view') {
            startScanner();
            checkNfcUrl();
        }
    }

    function handleLogout() {
        signOut(auth).then(() => {
            userRole = null;
            document.getElementById('header-nav').classList.add('hidden');
            document.getElementById('app-main-content').classList.add('hidden');
            document.getElementById('login-modal').classList.remove('hidden');
            document.getElementById('pin-input').value = '';
            stopScanner();
        }).catch((error) => {
            console.error("Erro ao fazer logout:", error);
        });
    }

    // --- MODO CRIADOR (GERAR CREDENCIAL) ---

    function generateClientId() {
        return 'ID-' + Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    function drawQrCode(text, elementId) {
        const element = document.getElementById(elementId);
        element.innerHTML = ''; 
        
        // Versão simples (Mock) da biblioteca QR Code
        try {
            const qr = new window.QRCode(element, {
                text: text,
                width: 192,
                height: 192,
                colorDark: "#10B981",
                colorLight: "#ffffff",
                correctLevel: window.QRCode.CorrectLevel.H
            });
        } catch (e) {
            console.warn("QRCode.js não carregado. Exibindo apenas o texto.");
            element.innerHTML = `<p class="text-xs text-red-500">Falha ao desenhar QR. ID: ${text}</p>`;
        }
    }

    async function handleCredentialFormSubmit(e) {
        e.preventDefault();
        const form = e.target;
        const statusDisplay = document.getElementById('creator-status');
        
        let clientId = document.getElementById('client-id-input').value || generateClientId();
        const clientName = document.getElementById('client-name-input').value;
        const pickupName = document.getElementById('pickup-name-input').value;
        const turma = document.getElementById('turma-input').value;
        const photoUrl = document.getElementById('photo-url-input').value;
        
        if (!userId) {
            statusDisplay.textContent = 'Erro: Usuário não autenticado. Tente fazer login novamente.';
            statusDisplay.className = 'text-sm mt-3 text-center text-red-500';
            return;
        }

        const clientRef = doc(db, 'artifacts', appId, 'client_details', clientId);
        const docSnap = await getDoc(clientRef);
        
        if (docSnap.exists()) {
             if(document.getElementById('client-id-input').value) {
                statusDisplay.textContent = 'Erro: O ID digitado já existe. Tente outro ou deixe o campo vazio para gerar um novo ID.';
                statusDisplay.className = 'text-sm mt-3 text-center text-red-500';
                return;
             }
             clientId = generateClientId();
        }

        const clientData = {
            clientId: clientId,
            clientName: clientName,
            pickupName: pickupName,
            turma: turma,
            photoUrl: photoUrl || `https://placehold.co/128x128/059669/ffffff?text=${clientId.substring(0, 4)}`,
            createdAt: serverTimestamp(),
            createdBy: userId 
        };

        try {
            await setDoc(clientRef, clientData); 
            
            statusDisplay.textContent = 'Cliente cadastrado com sucesso!';
            statusDisplay.className = 'text-sm mt-3 text-center text-emerald-600';
            form.reset();
            document.getElementById('client-id-input').value = clientId;

            // Gera e exibe o QR Code
            document.getElementById('qrcode-container').classList.remove('hidden');
            document.getElementById('generated-client-id').textContent = `ID Gerado: ${clientId}`;
            drawQrCode(clientId, 'qrcode-display');
            
        } catch (error) {
            console.error("Erro ao cadastrar cliente:", error);
            statusDisplay.textContent = `Erro ao salvar: ${error.message}`;
            statusDisplay.className = 'text-sm mt-3 text-center text-red-500';
        }
    }

    // --- MODO SCANNER/NFC ---

    function startScanner() {
        if (!html5QrCode) {
            html5QrCode = new Html5Qrcode("reader");
        }

        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        const statusDisplay = document.getElementById('scanner-status');

        if (!html5QrCode.isScanning) {
            html5QrCode.start({ facingMode: "environment" }, config, 
                (decodedText, decodedResult) => {
                    handleClientScan(decodedText);
                    statusDisplay.textContent = `QR Code Lido: ${decodedText}`;
                },
                (errorMessage) => {
                    // Sem resultado (ignora)
                })
            .catch((err) => {
                statusDisplay.textContent = "Erro ao iniciar a câmera. Verifique permissões.";
                console.error("Erro ao iniciar QR scanner:", err);
            });
            statusDisplay.textContent = "Câmera iniciada. Aponte para o QR Code.";
        }
    }

    function stopScanner() {
        if (html5QrCode && html
