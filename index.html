<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Check-in e Lista de Espera</title>
    <!-- Tailwind CSS (CDN) para estilização responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HTML5-QRCODE (para leitura de QR code) -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
    <style>
        /* Estilos customizados para o corpo da página e containers */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .container-app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
        }
        .card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 500px; /* Limite de largura para cartões de cadastro/login */
        }
        .manager-container {
            width: 100%;
            max-width: 900px;
        }
        .btn-primary {
            transition: all 0.2s;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>

<div id="app-container" class="container-app">

    <!-- Modal de Login (Tela Inicial) -->
    <div id="login-modal" class="w-full h-full flex items-center justify-center absolute inset-0 bg-gray-500 bg-opacity-75 z-50">
        <div class="card p-6 text-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Acesso Restrito</h2>
            <p class="text-gray-600 mb-6">Por favor, insira o PIN de acesso.</p>
            <input type="password" id="pin-input" class="w-full p-3 mb-4 border border-gray-300 rounded-lg text-lg text-center focus:ring-emerald-500 focus:border-emerald-500" placeholder="PIN de Acesso" maxlength="5">
            <button id="login-button" class="btn-primary w-full bg-emerald-600 text-white font-semibold py-3 rounded-lg hover:bg-emerald-700">Entrar</button>
            <p id="login-error" class="text-red-500 mt-3 hidden">PIN incorreto ou acesso não autorizado.</p>
            <p class="text-xs text-gray-400 mt-4">Gerente: 12345 | Scanner: 54321</p>
        </div>
    </div>
    
    <!-- Header de Navegação (visível após login) -->
    <div id="header-nav" class="w-full p-4 bg-white shadow-md mb-6 rounded-lg hidden max-w-5xl">
        <div class="flex flex-wrap justify-center gap-2">
            <button id="nav-manager" class="px-4 py-2 bg-emerald-500 text-white font-semibold rounded-full text-sm hover:bg-emerald-600 transition">Gerenciar Lista</button>
            <button id="nav-scanner" class="px-4 py-2 bg-sky-500 text-white font-semibold rounded-full text-sm hover:bg-sky-600 transition">Modo Scanner/NFC</button>
            <button id="nav-creator" class="px-4 py-2 bg-indigo-500 text-white font-semibold rounded-full text-sm hover:bg-indigo-600 transition">Gerar Credencial</button>
            <button id="nav-logout" class="px-4 py-2 bg-gray-300 text-gray-700 font-semibold rounded-full text-sm hover:bg-gray-400 transition ml-auto">Sair</button>
        </div>
    </div>

    <!-- Container Principal do App -->
    <main id="app-main-content" class="w-full flex-grow flex justify-center hidden">

        <!-- 1. Gerenciar Lista (Padrão/Gerente) -->
        <section id="manager-view" class="manager-container hidden">
            {

  apiKey: "AIzaSyAo8ujlZV0nh6CpPw7yvXgKjVDEOf0Q5Jc",

  authDomain: "checkin-escolar.firebaseapp.com",

  projectId: "checkin-escolar",

  storageBucket: "checkin-escolar.firebasestorage.app",

  messagingSenderId: "1028393700955",

  appId: "1:1028393700955:web:ebde11457658564451b97e",

  measurementId: "G-J3Y4P4E7CB"

};


        <!-- 2. Modo Scanner (Celular/Leitor) -->
        <section id="scanner-view" class="w-full max-w-md hidden">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Scanner de QR Code / NFC</h1>
            
            <!-- Área da Câmera / QR Code -->
            <div id="reader" class="w-full aspect-square bg-gray-200 rounded-xl overflow-hidden mb-6"></div>
            
            <p id="scanner-status" class="text-center text-gray-600">Aguardando leitura de QR Code ou ID via NFC...</p>

            <!-- Modal de Confirmação (Visível após a leitura) -->
            <div id="confirmation-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 z-40 hidden flex items-center justify-center p-4">
                <div class="card p-6 text-center max-w-sm">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Confirmar Cliente</h3>
                    <img id="client-photo" src="" alt="Foto do Cliente" class="w-24 h-24 rounded-full mx-auto object-cover mb-4 border-4 border-emerald-300">
                    <p class="text-xs text-gray-500 mb-1">Buscador (Cliente QR/NFC)</p>
                    <p id="modal-client-name" class="text-xl font-semibold text-gray-800 mb-3"></p>
                    
                    <div class="p-3 bg-indigo-50 rounded-lg mb-4 border border-indigo-200">
                        <p class="text-xs font-medium text-indigo-700">Pessoa Buscada & Turma</p>
                        <p id="modal-pickup-details" class="text-lg font-bold text-indigo-800"></p>
                    </div>

                    <p id="modal-status-message" class="text-sm font-medium mb-4 text-red-500"></p>
                    
                    <div class="flex gap-4">
                        <button id="confirm-identity-button" class="btn-primary flex-1 bg-emerald-600 text-white font-semibold py-3 rounded-lg hover:bg-emerald-700 disabled:opacity-50 transition">Confirmar Identidade</button>
                        <button id="cancel-scan-button" class="flex-1 bg-gray-300 text-gray-800 font-semibold py-3 rounded-lg hover:bg-gray-400 transition">Cancelar</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. Gerar Credencial (Gerente) -->
        <section id="creator-view" class="w-full max-w-md hidden">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Cadastro e Geração de Credencial</h1>
            <div class="card">
                <form id="credential-form" class="space-y-4">
                    <div>
                        <label for="client-id-input" class="block text-sm font-medium text-gray-700">ID Único do Cliente (Ex: CL001)</label>
                        <input type="text" id="client-id-input" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required placeholder="Gerado Automaticamente">
                    </div>
                    <div>
                        <label for="client-name-input" class="block text-sm font-medium text-gray-700">Nome do Buscador (Cliente)</label>
                        <input type="text" id="client-name-input" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required placeholder="Ex: Igor Kosiski">
                    </div>
                    <div>
                        <label for="pickup-name-input" class="block text-sm font-medium text-gray-700">Nome da Pessoa Buscada (Estudante)</label>
                        <input type="text" id="pickup-name-input" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required placeholder="Ex: Maria da Silva">
                    </div>
                    <div>
                        <label for="turma-input" class="block text-sm font-medium text-gray-700">Turma (do Buscado)</label>
                        <input type="text" id="turma-input" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required placeholder="Ex: 5º Ano B">
                    </div>
                    <div>
                        <label for="photo-url-input" class="block text-sm font-medium text-gray-700">URL da Foto do Buscador</label>
                        <input type="url" id="photo-url-input" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="URL da Foto (https://...)">
                        <p class="text-xs text-gray-500 mt-1">Use: https://placehold.co/128x128/059669/ffffff?text=FOTO+TESTE</p>
                    </div>
                    <button type="submit" class="btn-primary w-full bg-indigo-600 text-white font-semibold py-2 rounded-lg hover:bg-indigo-700 transition">Cadastrar Cliente e Gerar QR</button>
                    <p id="creator-status" class="text-sm mt-3 text-center"></p>
                </form>
                
                <div id="qrcode-container" class="mt-8 p-4 border border-gray-200 rounded-lg text-center hidden">
                    <h3 class="text-xl font-semibold mb-3">QR Code Gerado</h3>
                    <div id="qrcode-display" class="w-48 h-48 mx-auto"></div>
                    <p id="generated-client-id" class="mt-3 text-gray-600 font-mono text-sm break-all"></p>
                    <p class="text-xs text-red-500 mt-2">Salve esta imagem para o cliente.</p>
                </div>
            </div>
        </section>

    </main>
</div>

<!-- Scripts do Firebase e Lógica da Aplicação -->
<script type="module">
    // Variáveis globais de ambiente (fornecidas pelo sistema de execução)
    
    // As configurações de mock LOCAL_TEST_ID foram removidas aqui.
    // O sistema agora usará as variáveis injetadas pelo servidor web.
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    if (!firebaseConfig) {
        document.getElementById('app-container').innerHTML = '<div class="text-red-600 p-8 text-center">Erro: Configuração do Firebase não encontrada. Por favor, acesse via URL do Servidor (GitHub Pages)</div>';
        console.error("Firebase config is missing.");
        throw new Error("Firebase configuration is required.");
    }

    // Importações do Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    let app, db, auth, userId;
    let html5QrCode;
    let userRole = null; // 'manager', 'scanner', or null

    // --- FUNÇÕES DE UTILIDADE ---

    async function getClientDetails(clientId) {
        const clientDetailsRef = doc(db, 'artifacts', appId, 'client_details', clientId);
        try {
            const docSnap = await getDoc(clientDetailsRef);
            if (docSnap.exists()) {
                return { 
                    clientName: docSnap.data().clientName,
                    pickupName: docSnap.data().pickupName,
                    turma: docSnap.data().turma,
                    photoUrl: docSnap.data().photoUrl || `https://placehold.co/128x128/059669/ffffff?text=${clientId.substring(0, 4)}`,
                };
            }
        } catch (error) {
            console.error("Erro ao buscar detalhes do cliente no Firestore:", error);
        }
        
        // Mock/Fallback para ID não encontrado
        return {
            clientName: `Cliente Desconhecido (${clientId})`,
            pickupName: "Pessoa Não Cadastrada",
            turma: "Turma ?",
            photoUrl: `https://placehold.co/128x128/94A3B8/ffffff?text=${clientId.substring(0, 4)}`,
        };
    }

    async function isClientWaiting(clientId) {
        const waitingListCol = collection(db, 'artifacts', appId, 'public', 'data', 'waiting_list');
        const q = query(waitingListCol, 
            where('clientId', '==', clientId),
            where('status', '==', 'waiting')
        );
        const snapshot = await getDocs(q);
        return snapshot.size > 0;
    }

    // --- FIREBASE E AUTENTICAÇÃO ---

    async function initFirebase() {
        if (app) return;
        
        setLogLevel('debug');
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        try {
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }
        } catch (error) {
            console.error("Erro na autenticação:", error);
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                document.getElementById('user-id-display').textContent = userId;
            } else {
                userRole = null;
                document.getElementById('login-modal').classList.remove('hidden');
                document.getElementById('app-main-content').classList.add('hidden');
            }
        });
    }

    async function handleLogin() {
        const pinInput = document.getElementById('pin-input');
        const errorDisplay = document.getElementById('login-error');
        const pin = pinInput.value.trim();

        const configRef = doc(db, 'artifacts', appId, 'app_configs', 'access_pins');
        let pins = { managerPin: '12345', scannerPin: '54321' }; // Padrões

        try {
            const docSnap = await getDoc(configRef);
            if (docSnap.exists()) {
                pins = docSnap.data();
            } else {
                await setDoc(configRef, pins); // Salva os padrões iniciais
            }
        } catch (e) {
            console.warn("Não foi possível buscar/salvar PINs do Firestore, usando padrões locais.", e);
        }

        if (pin === pins.managerPin) {
            userRole = 'manager';
            errorDisplay.classList.add('hidden');
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('app-main-content').classList.remove('hidden');
            setupAppNavigation();
            showView('manager-view'); 
        } else if (pin === pins.scannerPin) {
            userRole = 'scanner';
            errorDisplay.classList.add('hidden');
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('app-main-content').classList.remove('hidden');
            setupAppNavigation();
            showView('scanner-view'); 
        } else {
            errorDisplay.classList.remove('hidden');
            pinInput.value = '';
            pinInput.focus();
        }
    }

    // --- NAVEGAÇÃO E VIEWS ---

    function setupAppNavigation() {
        document.getElementById('header-nav').classList.remove('hidden');

        const managerBtn = document.getElementById('nav-manager');
        const scannerBtn = document.getElementById('nav-scanner');
        const creatorBtn = document.getElementById('nav-creator');

        managerBtn.onclick = () => showView('manager-view');
        scannerBtn.onclick = () => showView('scanner-view');
        creatorBtn.onclick = () => showView('creator-view');
        document.getElementById('nav-logout').onclick = handleLogout;
        
        if (userRole === 'scanner') {
            managerBtn.classList.add('hidden');
            creatorBtn.classList.add('hidden');
        } else {
            managerBtn.classList.remove('hidden');
            creatorBtn.classList.remove('hidden');
        }
    }

    function showView(viewId) {
        ['manager-view', 'scanner-view', 'creator-view'].forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });

        if (viewId !== 'scanner-view' && html5QrCode && html5QrCode.isScanning) {
            stopScanner();
        }

        document.getElementById(viewId).classList.remove('hidden');
        
        if (viewId === 'manager-view') {
            loadWaitingList();
        } else if (viewId === 'scanner-view') {
            startScanner();
            checkNfcUrl();
        }
    }

    function handleLogout() {
        signOut(auth).then(() => {
            userRole = null;
            document.getElementById('header-nav').classList.add('hidden');
            document.getElementById('app-main-content').classList.add('hidden');
            document.getElementById('login-modal').classList.remove('hidden');
            document.getElementById('pin-input').value = '';
            stopScanner();
        }).catch((error) => {
            console.error("Erro ao fazer logout:", error);
        });
    }

    // --- MODO CRIADOR (GERAR CREDENCIAL) ---

    function generateClientId() {
        return 'ID-' + Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    function drawQrCode(text, elementId) {
        const element = document.getElementById(elementId);
        element.innerHTML = ''; 
        
        // Versão simples (Mock) da biblioteca QR Code
        try {
            const qr = new window.QRCode(element, {
                text: text,
                width: 192,
                height: 192,
                colorDark: "#10B981",
                colorLight: "#ffffff",
                correctLevel: window.QRCode.CorrectLevel.H
            });
        } catch (e) {
            console.warn("QRCode.js não carregado. Exibindo apenas o texto.");
            element.innerHTML = `<p class="text-xs text-red-500">Falha ao desenhar QR. ID: ${text}</p>`;
        }
    }

    async function handleCredentialFormSubmit(e) {
        e.preventDefault();
        const form = e.target;
        const statusDisplay = document.getElementById('creator-status');
        
        let clientId = document.getElementById('client-id-input').value || generateClientId();
        const clientName = document.getElementById('client-name-input').value;
        const pickupName = document.getElementById('pickup-name-input').value;
        const turma = document.getElementById('turma-input').value;
        const photoUrl = document.getElementById('photo-url-input').value;
        
        if (!userId) {
            statusDisplay.textContent = 'Erro: Usuário não autenticado. Tente fazer login novamente.';
            statusDisplay.className = 'text-sm mt-3 text-center text-red-500';
            return;
        }

        const clientRef = doc(db, 'artifacts', appId, 'client_details', clientId);
        const docSnap = await getDoc(clientRef);
        
        if (docSnap.exists()) {
             if(document.getElementById('client-id-input').value) {
                statusDisplay.textContent = 'Erro: O ID digitado já existe. Tente outro ou deixe o campo vazio para gerar um novo ID.';
                statusDisplay.className = 'text-sm mt-3 text-center text-red-500';
                return;
             }
             clientId = generateClientId();
        }

        const clientData = {
            clientId: clientId,
            clientName: clientName,
            pickupName: pickupName,
            turma: turma,
            photoUrl: photoUrl || `https://placehold.co/128x128/059669/ffffff?text=${clientId.substring(0, 4)}`,
            createdAt: serverTimestamp(),
            createdBy: userId // userId AGORA está garantido pela autenticação do servidor web
        };

        try {
            await setDoc(clientRef, clientData); 
            
            statusDisplay.textContent = 'Cliente cadastrado com sucesso!';
            statusDisplay.className = 'text-sm mt-3 text-center text-emerald-600';
            form.reset();
            document.getElementById('client-id-input').value = clientId;

            // Gera e exibe o QR Code
            document.getElementById('qrcode-container').classList.remove('hidden');
            document.getElementById('generated-client-id').textContent = `ID Gerado: ${clientId}`;
            drawQrCode(clientId, 'qrcode-display');
            
        } catch (error) {
            console.error("Erro ao cadastrar cliente:", error);
            statusDisplay.textContent = `Erro ao salvar: ${error.message}`;
            statusDisplay.className = 'text-sm mt-3 text-center text-red-500';
        }
    }

    // --- MODO SCANNER/NFC ---

    function startScanner() {
        if (!html5QrCode) {
            html5QrCode = new Html5Qrcode("reader");
        }

        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        const statusDisplay = document.getElementById('scanner-status');

        if (!html5QrCode.isScanning) {
            html5QrCode.start({ facingMode: "environment" }, config, 
                (decodedText, decodedResult) => {
                    handleClientScan(decodedText);
                    statusDisplay.textContent = `QR Code Lido: ${decodedText}`;
                },
                (errorMessage) => {
                    // Sem resultado (ignora)
                })
            .catch((err) => {
                statusDisplay.textContent = "Erro ao iniciar a câmera. Verifique permissões.";
                console.error("Erro ao iniciar QR scanner:", err);
            });
            statusDisplay.textContent = "Câmera iniciada. Aponte para o QR Code.";
        }
    }

    function stopScanner() {
        if (html5QrCode && html5QrCode.isScanning) {
            html5QrCode.stop().catch(err => console.error("Erro ao parar scanner:", err));
            document.getElementById('scanner-status').textContent = "Scanner Parado.";
        }
    }

    function checkNfcUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        const clientId = urlParams.get('clientId');
        
        if (clientId) {
            history.replaceState(null, '', window.location.pathname + window.location.hash);
            handleClientScan(clientId);
            document.getElementById('scanner-status').textContent = `ID recebido via NFC/URL: ${clientId}`;
        }
    }

    let scannedClientId = null; 

    async function handleClientScan(clientId) {
        stopScanner(); 
        scannedClientId = clientId;
        const modal = document.getElementById('confirmation-modal');
        const confirmBtn = document.getElementById('confirm-identity-button');
        const statusMsg = document.getElementById('modal-status-message');

        const details = await getClientDetails(clientId);
        
        document.getElementById('client-photo').src = details.photoUrl;
        document.getElementById('modal-client-name').textContent = details.clientName;
        document.getElementById('modal-pickup-details').textContent = `${details.pickupName} | Turma: ${details.turma}`;
        confirmBtn.disabled = false;
        statusMsg.classList.add('hidden');
        
        if (await isClientWaiting(clientId)) {
            statusMsg.textContent = "ATENÇÃO: Este cliente JÁ está na fila!";
            statusMsg.classList.remove('hidden');
            confirmBtn.disabled = true; 
        }

        modal.classList.remove('hidden');
    }

    async function confirmClientCheckin() {
        const modal = document.getElementById('confirmation-modal');
        const confirmBtn = document.getElementById('confirm-identity-button');
        
        if (!scannedClientId) return;
        
        confirmBtn.disabled = true;

        const details = await getClientDetails(scannedClientId);
        
        const waitingListCol = collection(db, 'artifacts', appId, 'public', 'data', 'waiting_list');
        
        const checkinData = {
            clientId: scannedClientId,
            clientName: details.clientName,
            pickupName: details.pickupName,
            turma: details.turma,
            photoUrl: details.photoUrl,
            status: 'waiting', 
            checkinTime: serverTimestamp(),
            checkedBy: userId
        };

        try {
            await addDoc(waitingListCol, checkinData);
            
            modal.classList.add('hidden');
            scannedClientId = null;
            setTimeout(startScanner, 1000); 
            
        } catch (error) {
            console.error("Erro ao adicionar cliente à lista:", error);
            confirmBtn.disabled = false;
        }
    }

    function cancelScan() {
        document.getElementById('confirmation-modal').classList.add('hidden');
        scannedClientId = null;
        startScanner(); 
    }


    // --- MODO GERENCIADOR (LISTA DE ESPERA) ---

    function renderWaitingList(tasks) {
        const listContainer = document.getElementById('waiting-list');
        listContainer.innerHTML = ''; 

        if (tasks.length === 0) {
            listContainer.innerHTML = '<p class="text-center text-gray-500 p-8">Nenhum cliente na lista de espera no momento.</p>';
            return;
        }

        tasks.sort((a, b) => {
            const timeA = a.checkinTime && a.checkinTime.seconds ? a.checkinTime.seconds : 0;
            const timeB = b.checkinTime && b.checkinTime.seconds ? b.checkinTime.seconds : 0;
            return timeA - timeB;
        });

        tasks.forEach(task => {
            const time = task.checkinTime && task.checkinTime.seconds ? new Date(task.checkinTime.seconds * 1000).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : 'Hora Desconhecida';
            const statusColor = task.status === 'waiting' ? 'bg-red-100 border-red-300' : 'bg-green-100 border-green-300';
            const statusText = task.status === 'waiting' ? 'Aguardando' : 'Servido';
            
            const card = document.createElement('div');
            card.className = `p-4 border-l-4 rounded-lg flex justify-between items-center ${statusColor}`;
            card.innerHTML = `
                <div class="flex items-center space-x-4">
                    <img src="${task.photoUrl}" onerror="this.onerror=null; this.src='https://placehold.co/40x40/94A3B8/ffffff?text=?'" alt="Foto" class="w-10 h-10 rounded-full object-cover border-2 border-white shadow">
                    <div>
                        <div class="text-lg font-bold text-gray-900">${task.pickupName} <span class="text-sm font-medium text-indigo-700">(${task.turma})</span></div>
                        <div class="text-sm text-gray-600">Buscador: ${task.clientName} | Check-in: ${time}</div>
                        <div class="text-xs font-semibold mt-1 px-2 py-0.5 rounded-full ${task.status === 'waiting' ? 'bg-red-500 text-white' : 'bg-green-500 text-white'}">${statusText}</div>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button data-id="${task.id}" data-status="called" class="action-btn px-3 py-1 bg-yellow-500 text-white rounded-md text-sm hover:bg-yellow-600 transition">Chamar</button>
                    <button data-id="${task.id}" data-status="served" class="action-btn px-3 py-1 ${task.status === 'waiting' ? 'bg-green-600' : 'bg-gray-400 cursor-not-allowed' } text-white rounded-md text-sm hover:bg-green-700 transition" ${task.status !== 'waiting' ? 'disabled' : ''}>Servido</button>
                    <button data-id="${task.id}" data-status="remove" class="action-btn px-3 py-1 bg-red-600 text-white rounded-md text-sm hover:bg-red-700 transition">Remover</button>
                </div>
            `;
            listContainer.appendChild(card);
        });

        listContainer.querySelectorAll('.action-btn').forEach(button => {
            button.addEventListener('click', handleListAction);
        });
    }

    function loadWaitingList() {
        if (!db) return;
        
        const waitingListCol = collection(db, 'artifacts', appId, 'public', 'data', 'waiting_list');
        const q = query(waitingListCol, where('status', 'in', ['waiting', 'called']));

        document.getElementById('loading-list').classList.remove('hidden');

        // Este onSnapshot AGORA funcionará quando acessado via URL do GitHub
        onSnapshot(q, (snapshot) => {
            document.getElementById('loading-list').classList.add('hidden');
            const tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderWaitingList(tasks);
        }, (error) => {
            console.error("Erro no listener do Firestore:", error);
            document.getElementById('loading-list').textContent = 'Erro ao carregar a lista. Verifique as permissões no console.';
        });
    }

    async function handleListAction(e) {
        const id = e.target.dataset.id;
        const status = e.target.dataset.status;
        
        const taskRef = doc(db, 'artifacts', appId, 'public', 'data', 'waiting_list', id);

        try {
            if (status === 'remove') {
                await deleteDoc(taskRef);
            } else {
                await updateDoc(taskRef, { 
                    status: status,
                    actionTime: serverTimestamp(),
                    actionBy: userId 
                });
            }
        } catch (error) {
            console.error(`Erro ao executar ação ${status} em ${id}:`, error);
        }
    }


    // --- INICIALIZAÇÃO E LISTENERS GERAIS ---

    window.onload = function () {
        initFirebase();
        
        document.getElementById('login-button').addEventListener('click', handleLogin);
        document.getElementById('pin-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleLogin();
        });
        
        document.getElementById('credential-form').addEventListener('submit', handleCredentialFormSubmit);

        document.getElementById('confirm-identity-button').addEventListener('click', confirmClientCheckin);
        document.getElementById('cancel-scan-button').addEventListener('click', cancelScan);

        if (window.location.search.includes('clientId=')) {
            document.getElementById('login-modal').classList.remove('hidden');
        }
    };
    
    // --- INJEÇÃO DA BIBLIOTECA QRCODE.JS (SIMPLIFICADA) ---
    window.QRCode = function (el, options) {
        if(typeof el === 'string') el = document.getElementById(el);
        if(!el) return;
        
        const canvas = document.createElement('canvas');
        el.appendChild(canvas);
        
        const size = options.width || 192;
        canvas.width = size;
        canvas.height = size;
        
        const ctx = canvas.getContext('2d');
        const dark = options.colorDark || '#000000';
        const light = options.colorLight || '#ffffff';
        const text = options.text || 'ID';
        
        ctx.fillStyle = light;
        ctx.fillRect(0, 0, size, size);
        ctx.fillStyle = dark;
        
        const cell = size / 10;
        ctx.fillRect(cell, cell, 3 * cell, 3 * cell);
        ctx.fillRect(6 * cell, cell, 3 * cell, 3 * cell);
        ctx.fillRect(cell, 6 * cell, 3 * cell, 3 * cell);
        
        ctx.font = `${cell}px Arial`;
        ctx.fillStyle = dark;
        ctx.textAlign = 'center';
        ctx.fillText(text.substring(0, 8), size / 2, size / 2);
    };

</script>
    
